<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Belfast Bikes ‚Äî Live Availability</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=DM+Mono:wght@400;500&family=Syne:wght@700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    :root {
      --bg: #0d0f14;
      --surface: #151820;
      --border: #252a35;
      --green: #00e0a0;
      --orange: #ff6b35;
      --yellow: #ffd166;
      --purple: #b388ff;
      --text: #e8eaf0;
      --muted: #5a6070;
      --radius: 8px;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'DM Mono', monospace;
      background: var(--bg); color: var(--text);
      height: 100vh; display: flex; flex-direction: column; overflow: hidden;
    }
    header {
      display: flex; align-items: center; justify-content: space-between;
      padding: 14px 24px; background: var(--surface);
      border-bottom: 1px solid var(--border); z-index: 1000; flex-shrink: 0;
    }
    .logo { display: flex; align-items: center; gap: 12px; }
    .logo-icon { font-size: 22px; }
    h1 { font-family: 'Syne', sans-serif; font-size: 1.2rem; font-weight: 800; letter-spacing: -0.02em; }
    h1 span { color: var(--green); }
    .status-bar { display: flex; align-items: center; gap: 20px; font-size: 0.72rem; color: var(--muted); }
    .pulse-dot {
      width: 8px; height: 8px; border-radius: 50%; background: var(--green);
      animation: pulse 2s infinite; display: inline-block; margin-right: 6px;
    }
    @keyframes pulse {
      0%,100% { opacity:1; transform:scale(1); }
      50%      { opacity:0.4; transform:scale(0.8); }
    }
    #last-updated { color: var(--text); }
    .refresh-btn {
      background: none; border: 1px solid var(--border); color: var(--muted);
      padding: 5px 12px; border-radius: var(--radius); cursor: pointer;
      font-family: 'DM Mono', monospace; font-size: 0.72rem; transition: all 0.2s;
    }
    .refresh-btn:hover { border-color: var(--green); color: var(--green); }
    .main { display: flex; flex: 1; overflow: hidden; }

    /* Sidebar */
    .sidebar {
      width: 310px; flex-shrink: 0; background: var(--surface);
      border-right: 1px solid var(--border); display: flex; flex-direction: column; overflow: hidden;
    }
    .sidebar-header { padding: 14px 16px; border-bottom: 1px solid var(--border); }
    .sidebar-title {
      font-family: 'Syne', sans-serif; font-size: 0.7rem; font-weight: 700;
      letter-spacing: 0.1em; text-transform: uppercase; color: var(--muted); margin-bottom: 10px;
    }

    /* Toggle filter buttons */
    .filter-toggles { display: grid; grid-template-columns: repeat(4, 1fr); gap: 6px; }

    .toggle-btn {
      background: var(--bg); border: 1px solid var(--border);
      border-radius: var(--radius); padding: 8px 6px; text-align: center;
      cursor: pointer; transition: all 0.2s; position: relative; user-select: none;
    }
    .toggle-btn:hover { border-color: var(--muted); }

    .toggle-btn.active-bikes    { border-color: var(--green);  background: rgba(0,224,160,0.1); }
    .toggle-btn.active-ebikes   { border-color: var(--yellow); background: rgba(255,209,102,0.1); }
    .toggle-btn.active-scooters { border-color: var(--purple); background: rgba(179,136,255,0.1); }
    .toggle-btn.active-docks    { border-color: var(--orange); background: rgba(255,107,53,0.1); }

    .toggle-btn.dimmed { opacity: 0.35; }

    .toggle-value {
      font-family: 'Syne', sans-serif; font-size: 1.3rem;
      font-weight: 800; line-height: 1; margin-bottom: 4px;
    }
    .toggle-value.bikes    { color: var(--green); }
    .toggle-value.ebikes   { color: var(--yellow); }
    .toggle-value.scooters { color: var(--purple); }
    .toggle-value.docks    { color: var(--orange); }
    .toggle-label { font-size: 0.58rem; color: var(--muted); text-transform: uppercase; letter-spacing: 0.05em; }

    .toggle-tick {
      position: absolute; top: 4px; right: 5px;
      font-size: 0.55rem; opacity: 0; transition: opacity 0.15s;
    }
    .toggle-btn.active-bikes .toggle-tick,
    .toggle-btn.active-ebikes .toggle-tick,
    .toggle-btn.active-scooters .toggle-tick,
    .toggle-btn.active-docks .toggle-tick { opacity: 1; }

    /* Filter hint */
    .filter-hint {
      padding: 6px 16px 0;
      font-size: 0.62rem; color: var(--muted); min-height: 18px;
      transition: opacity 0.2s;
    }

    /* Legend */
    .legend {
      padding: 8px 16px 10px; border-bottom: 1px solid var(--border);
      display: flex; gap: 14px; flex-wrap: wrap;
    }
    .legend-item { display: flex; align-items: center; gap: 5px; font-size: 0.65rem; color: var(--muted); }
    .legend-dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }

    .search-box { padding: 10px 16px; border-bottom: 1px solid var(--border); }
    .search-box input {
      width: 100%; background: var(--bg); border: 1px solid var(--border);
      border-radius: var(--radius); color: var(--text); padding: 7px 12px;
      font-family: 'DM Mono', monospace; font-size: 0.75rem; outline: none; transition: border-color 0.2s;
    }
    .search-box input:focus { border-color: var(--green); }
    .search-box input::placeholder { color: var(--muted); }

    .station-list { flex: 1; overflow-y: auto; padding: 8px; }
    .station-list::-webkit-scrollbar { width: 4px; }
    .station-list::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

    .station-item {
      padding: 10px 12px; border-radius: var(--radius); border: 1px solid transparent;
      cursor: pointer; transition: all 0.15s; margin-bottom: 4px; animation: slideIn 0.3s ease both;
    }
    @keyframes slideIn {
      from { opacity:0; transform:translateX(-8px); }
      to   { opacity:1; transform:translateX(0); }
    }
    .station-item:hover { background: var(--bg); border-color: var(--border); }
    .station-item.active { background: rgba(0,224,160,0.07); border-color: var(--green); }
    .station-item.closed { opacity: 0.4; }
    .station-item.filtered-out { opacity: 0.15; pointer-events: none; }

    .station-name {
      font-size: 0.75rem; font-weight: 500; color: var(--text);
      margin-bottom: 7px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    }
    .station-closed-badge {
      font-size: 0.6rem; color: var(--orange); border: 1px solid var(--orange);
      border-radius: 4px; padding: 1px 5px; margin-left: 6px; vertical-align: middle;
    }
    .vehicle-chips { display: flex; gap: 5px; flex-wrap: wrap; }
    .chip {
      display: flex; align-items: center; gap: 4px;
      padding: 2px 7px; border-radius: 20px; font-size: 0.65rem; border: 1px solid;
    }
    .chip.bike    { color: var(--green);  border-color: rgba(0,224,160,0.3);   background: rgba(0,224,160,0.07); }
    .chip.ebike   { color: var(--yellow); border-color: rgba(255,209,102,0.3); background: rgba(255,209,102,0.07); }
    .chip.scooter { color: var(--purple); border-color: rgba(179,136,255,0.3); background: rgba(179,136,255,0.07); }
    .chip.empty   { color: var(--muted);  border-color: var(--border);         background: transparent; }

    #map { flex: 1; }

    /* Loading */
    .loading-overlay {
      position: absolute; inset: 0; background: var(--bg); display: flex;
      flex-direction: column; align-items: center; justify-content: center;
      z-index: 9999; gap: 16px; transition: opacity 0.4s;
    }
    .loading-overlay.hidden { opacity: 0; pointer-events: none; }
    .spinner {
      width: 40px; height: 40px; border: 3px solid var(--border);
      border-top-color: var(--green); border-radius: 50%; animation: spin 0.8s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    .loading-text { font-family: 'Syne', sans-serif; font-size: 0.85rem; color: var(--muted); }

    /* Leaflet overrides */
    .leaflet-container { background: #0d0f14; }
    .leaflet-tile { filter: brightness(0.6) saturate(0.5) hue-rotate(190deg); }
    .leaflet-control-zoom a { background: var(--surface) !important; color: var(--text) !important; border-color: var(--border) !important; }
    .leaflet-control-attribution { background: rgba(13,15,20,0.8) !important; color: var(--muted) !important; }
    .leaflet-control-attribution a { color: var(--muted) !important; }

    /* Markers */
    .marker-bubble {
      background: var(--surface); border: 2px solid var(--green);
      border-radius: 10px; padding: 3px 8px;
      font-family: 'DM Mono', monospace; font-size: 0.68rem; font-weight: 500;
      color: var(--text); white-space: nowrap; box-shadow: 0 4px 20px rgba(0,0,0,0.5);
      display: flex; align-items: center; gap: 5px; transition: transform 0.15s, opacity 0.25s;
    }
    .marker-bubble:hover { transform: scale(1.06); }
    .marker-bubble.empty  { border-color: var(--orange); opacity: 0.65; }
    .marker-bubble.low    { border-color: var(--yellow); }
    .marker-bubble.closed { border-color: var(--muted); opacity: 0.4; }
    .marker-bubble.faded  { opacity: 0.1; }
    .marker-vehicle { display: flex; align-items: center; gap: 2px; }
    .marker-vehicle + .marker-vehicle { border-left: 1px solid var(--border); padding-left: 5px; }

    /* Popup */
    .leaflet-popup-content-wrapper {
      background: var(--surface) !important; border: 1px solid var(--border) !important;
      border-radius: var(--radius) !important; box-shadow: 0 8px 32px rgba(0,0,0,0.6) !important;
      color: var(--text) !important;
    }
    .leaflet-popup-tip { background: var(--surface) !important; }
    .popup-content { font-family: 'DM Mono', monospace; min-width: 200px; }
    .popup-name { font-family: 'Syne', sans-serif; font-size: 0.9rem; font-weight: 700; margin-bottom: 10px; }
    .popup-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; font-size: 0.72rem; }
    .popup-row-label { color: var(--muted); }
    .popup-divider { border: none; border-top: 1px solid var(--border); margin: 8px 0; }
    .popup-vehicle-row { display: flex; align-items: center; justify-content: space-between; margin-bottom: 5px; font-size: 0.72rem; }
    .popup-avail-bar { margin-top: 10px; height: 4px; background: var(--border); border-radius: 2px; overflow: hidden; }
    .popup-avail-fill { height: 100%; background: var(--green); border-radius: 2px; }
  </style>
</head>
<body>

<div class="loading-overlay" id="loading">
  <div class="spinner"></div>
  <div class="loading-text">Fetching live station data‚Ä¶</div>
</div>

<header>
  <div class="logo">
    <span class="logo-icon">üö≤</span>
    <h1>Belfast <span>Bikes</span></h1>
  </div>
  <div class="status-bar">
    <span><span class="pulse-dot"></span>LIVE</span>
    <span>Updated: <span id="last-updated">‚Äî</span></span>
    <button class="refresh-btn" onclick="loadStations()">‚Üª Refresh</button>
  </div>
</header>

<div class="main">
  <div class="sidebar">
    <div class="sidebar-header">
      <div class="sidebar-title">Network Summary</div>
      <div class="filter-toggles">

        <div class="toggle-btn" id="toggle-bikes" onclick="toggleFilter('bikes')" title="Filter: standard bikes">
          <span class="toggle-tick" style="color:var(--green)">‚úì ON</span>
          <div class="toggle-value bikes" id="total-bikes">‚Äî</div>
          <div class="toggle-label">üö≤ Bikes</div>
        </div>

        <div class="toggle-btn" id="toggle-ebikes" onclick="toggleFilter('ebikes')" title="Filter: e-bikes">
          <span class="toggle-tick" style="color:var(--yellow)">‚úì ON</span>
          <div class="toggle-value ebikes" id="total-ebikes">‚Äî</div>
          <div class="toggle-label">‚ö° E-bikes</div>
        </div>

        <div class="toggle-btn" id="toggle-scooters" onclick="toggleFilter('scooters')" title="Filter: e-scooters">
          <span class="toggle-tick" style="color:var(--purple)">‚úì ON</span>
          <div class="toggle-value scooters" id="total-scooters">‚Äî</div>
          <div class="toggle-label">üõ¥ Scooters</div>
        </div>

        <div class="toggle-btn" id="toggle-docks" onclick="toggleFilter('docks')" title="Filter: free docks">
          <span class="toggle-tick" style="color:var(--orange)">‚úì ON</span>
          <div class="toggle-value docks" id="total-docks">‚Äî</div>
          <div class="toggle-label">üÖø Docks</div>
        </div>

      </div>
    </div>

    <div class="filter-hint" id="filter-hint"></div>

    <div class="legend">
      <div class="legend-item"><div class="legend-dot" style="background:var(--green)"></div>Available</div>
      <div class="legend-item"><div class="legend-dot" style="background:var(--yellow)"></div>Low (&lt;25%)</div>
      <div class="legend-item"><div class="legend-dot" style="background:var(--orange)"></div>Empty</div>
      <div class="legend-item"><div class="legend-dot" style="background:var(--muted)"></div>Closed</div>
    </div>

    <div class="search-box">
      <input type="text" id="search" placeholder="Search stations‚Ä¶" oninput="filterStations(this.value)" />
    </div>
    <div class="station-list" id="station-list"></div>
  </div>

  <div id="map"></div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
  const API_URL = 'http://localhost:3000/api/stations';
  const BELFAST_CENTER = [54.5973, -5.9301];
  const REFRESH_MS = 60000;

  let map, markers = [];
  let allStations = [];
  let activeId = null;
  let searchQuery = '';

  // Which filters are active (null = no filter active)
  let activeFilter = null; // 'bikes' | 'ebikes' | 'scooters' | 'docks' | null

  map = L.map('map', { center: BELFAST_CENTER, zoom: 14 });
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '¬© OpenStreetMap contributors', maxZoom: 19
  }).addTo(map);

  // Filter toggle logic
  function toggleFilter(type) {
    activeFilter = (activeFilter === type) ? null : type;
    applyFilter();
  }

  function stationMatchesFilter(s) {
    if (!activeFilter) return true;
    if (activeFilter === 'bikes')    return s.bikes > 0;
    if (activeFilter === 'ebikes')   return s.ebikes > 0;
    if (activeFilter === 'scooters') return s.scooters > 0;
    if (activeFilter === 'docks')    return s.empty_slots > 0;
    return true;
  }

  function applyFilter() {
    // Update toggle button styles
    const types = ['bikes', 'ebikes', 'scooters', 'docks'];
    types.forEach(t => {
      const btn = document.getElementById('toggle-' + t);
      btn.className = 'toggle-btn';
      if (activeFilter === t) {
        btn.classList.add('active-' + t);
      } else if (activeFilter !== null) {
        btn.classList.add('dimmed');
      }
    });

    // Update hint text
    const hint = document.getElementById('filter-hint');
    if (activeFilter) {
      const labels = { bikes: 'üö≤ standard bikes', ebikes: '‚ö° e-bikes', scooters: 'üõ¥ e-scooters', docks: 'üÖø free docks' };
      const count = allStations.filter(stationMatchesFilter).length;
      hint.textContent = 'Showing ' + count + ' stations with ' + labels[activeFilter] + ' ‚Äî click again to clear';
    } else {
      hint.textContent = '';
    }

    // Fade/show markers on map
    allStations.forEach(s => {
      if (!s._marker) return;
      const el = s._marker.getElement();
      if (!el) return;
      const bubble = el.querySelector('.marker-bubble');
      if (!bubble) return;
      if (activeFilter && !stationMatchesFilter(s)) {
        bubble.classList.add('faded');
      } else {
        bubble.classList.remove('faded');
      }
    });

    // Re-render list with filter applied (respecting search too)
    renderList(getFilteredList());
  }

  function getFilteredList() {
    return allStations.filter(s => {
      const matchesSearch = s.name.toLowerCase().includes(searchQuery.toLowerCase());
      return matchesSearch;
    });
  }

  function markerClass(s) {
    if (!s.is_renting) return 'closed';
    if (s.free_bikes === 0) return 'empty';
    const total = s.free_bikes + s.empty_slots;
    if (total > 0 && s.free_bikes / total < 0.25) return 'low';
    return '';
  }

  function createMarker(s) {
    const cls = markerClass(s);
    const parts = [];
    if (s.bikes > 0)    parts.push('<span class="marker-vehicle">üö≤ ' + s.bikes + '</span>');
    if (s.ebikes > 0)   parts.push('<span class="marker-vehicle">‚ö° ' + s.ebikes + '</span>');
    if (s.scooters > 0) parts.push('<span class="marker-vehicle">üõ¥ ' + s.scooters + '</span>');
    if (parts.length === 0) parts.push('<span class="marker-vehicle" style="color:var(--muted)">Empty</span>');

    const html = '<div class="marker-bubble ' + cls + '">' + parts.join('') + '</div>';
    const icon = L.divIcon({ html: html, className: '', iconAnchor: [40, 16] });
    const marker = L.marker([s.latitude, s.longitude], { icon });

    const total = s.free_bikes + s.empty_slots;
    const pct = total > 0 ? Math.round((s.free_bikes / total) * 100) : 0;
    const statusStr = !s.is_renting
      ? '<span style="color:var(--orange)">Closed</span>'
      : '<span style="color:var(--green)">Open</span>';

    const popup = '<div class="popup-content">' +
      '<div class="popup-name">' + s.name + '</div>' +
      '<div class="popup-row"><span class="popup-row-label">Status</span>' + statusStr + '</div>' +
      '<div class="popup-row"><span class="popup-row-label">Capacity</span><span>' + (s.capacity || '‚Äî') + '</span></div>' +
      '<div class="popup-row"><span class="popup-row-label">Free docks</span><span style="color:var(--orange)">' + s.empty_slots + '</span></div>' +
      '<hr class="popup-divider">' +
      '<div class="popup-vehicle-row"><span>üö≤ Standard bikes</span><span style="color:var(--green)">' + s.bikes + '</span></div>' +
      '<div class="popup-vehicle-row"><span>‚ö° E-bikes</span><span style="color:var(--yellow)">' + s.ebikes + '</span></div>' +
      '<div class="popup-vehicle-row"><span>üõ¥ E-scooters</span><span style="color:var(--purple)">' + s.scooters + '</span></div>' +
      '<div class="popup-avail-bar"><div class="popup-avail-fill" style="width:' + pct + '%"></div></div>' +
      '</div>';

    marker.bindPopup(popup);
    marker.on('click', () => highlightStation(s.id));
    return marker;
  }

  function renderStations(stations) {
    markers.forEach(m => map.removeLayer(m));
    markers = [];
    let totalBikes = 0, totalEbikes = 0, totalScooters = 0, totalDocks = 0;
    stations.forEach(s => {
      totalBikes    += s.bikes;
      totalEbikes   += s.ebikes;
      totalScooters += s.scooters;
      totalDocks    += s.empty_slots;
      const m = createMarker(s);
      m.addTo(map);
      markers.push(m);
      s._marker = m;
    });
    document.getElementById('total-bikes').textContent    = totalBikes;
    document.getElementById('total-ebikes').textContent   = totalEbikes;
    document.getElementById('total-scooters').textContent = totalScooters;
    document.getElementById('total-docks').textContent    = totalDocks;

    // Re-apply any active filter after re-render
    applyFilter();
  }

  function renderList(stations) {
    const list = document.getElementById('station-list');
    if (!stations.length) {
      list.innerHTML = '<div style="padding:20px;text-align:center;color:var(--muted);font-size:0.8rem">No stations found.</div>';
      return;
    }
    list.innerHTML = stations.map((s, idx) => {
      const delay = Math.min(idx * 15, 400);
      const closed = !s.is_renting ? ' closed' : '';
      const filteredOut = (activeFilter && !stationMatchesFilter(s)) ? ' filtered-out' : '';
      const badge = !s.is_renting ? '<span class="station-closed-badge">CLOSED</span>' : '';

      const chips = [];
      if (s.bikes > 0)    chips.push('<span class="chip bike">üö≤ ' + s.bikes + '</span>');
      if (s.ebikes > 0)   chips.push('<span class="chip ebike">‚ö° ' + s.ebikes + '</span>');
      if (s.scooters > 0) chips.push('<span class="chip scooter">üõ¥ ' + s.scooters + '</span>');
      if (chips.length === 0) chips.push('<span class="chip empty">No vehicles</span>');

      return '<div class="station-item' + (activeId === s.id ? ' active' : '') + closed + filteredOut + '" ' +
        'id="item-' + s.id + '" ' +
        'onclick="highlightStation(\'' + s.id + '\')" ' +
        'style="animation-delay:' + delay + 'ms">' +
        '<div class="station-name">' + s.name + badge + '</div>' +
        '<div class="vehicle-chips">' + chips.join('') + '</div>' +
        '</div>';
    }).join('');
  }

  function highlightStation(id) {
    activeId = id;
    const s = allStations.find(x => x.id === id);
    if (!s) return;
    document.querySelectorAll('.station-item').forEach(el => el.classList.remove('active'));
    const item = document.getElementById('item-' + id);
    if (item) { item.classList.add('active'); item.scrollIntoView({ behavior: 'smooth', block: 'nearest' }); }
    if (s._marker) {
      map.flyTo([s.latitude, s.longitude], 16, { duration: 0.8 });
      setTimeout(() => s._marker.openPopup(), 500);
    }
  }

  function filterStations(q) {
    searchQuery = q;
    renderList(getFilteredList());
  }

  async function loadStations() {
    try {
      const res = await fetch(API_URL);
      if (!res.ok) throw new Error('Server error: ' + res.status);
      const data = await res.json();
      allStations = (data.network?.stations || []).sort((a, b) => a.name.localeCompare(b.name));
      if (!allStations.length) throw new Error('No station data');
      renderStations(allStations);
      renderList(getFilteredList());
      const now = new Date();
      document.getElementById('last-updated').textContent =
        now.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
      document.getElementById('loading').classList.add('hidden');
    } catch (err) {
      console.error(err);
      document.getElementById('loading').innerHTML =
        '<div style="text-align:center;color:var(--orange);font-family:DM Mono,monospace;padding:20px">' +
        '<div style="font-size:2rem;margin-bottom:12px">‚ö†Ô∏è</div>' +
        '<div>Could not connect to local server.</div>' +
        '<div style="color:var(--muted);font-size:0.8rem;margin-top:8px">Make sure you have run npm start in your terminal.</div></div>';
    }
  }

  loadStations();
  setInterval(loadStations, REFRESH_MS);
</script>
</body>
</html>
